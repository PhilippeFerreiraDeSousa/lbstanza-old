defpackage stz/pkg-ir :
  import core
  import collections

  ;All included IRs.
  import stz/asm-ir with :
    prefix(AddOp, SubOp, MulOp, DivOp, ModOp, AndOp, OrOp, XorOp, ShlOp,
           ShrOp, AshrOp, EqOp, NeOp, LtOp, GtOp, LeOp, GeOp, UleOp,
           UltOp, UgtOp, UgeOp, NotOp, NegOp, DivModOp, BitSetOp, BitNotSetOp, LowestZeroBitCountOp,
           TestBitOp, TestAndSetBitOp, TestAndClearBitOp, SetBitOp, ClearBitOp,
           TypeofOp, XchgIns, SetIns, ConvertIns, InterpretIns, UnaOp, BinOp, VoidBinOp,
           DualOp, Load, Store, Call, Return, Goto, Break, Label, LinkLabel,
           ExLabel, Match, Dispatch, MethodDispatch, DefData, DefText, DefDirectives, DefExportLabel, DefByte,
           DefInt, DefLong, DefFloat, DefDouble, DefString, DefBytes, DefSpace, DefLabel, Comment) => asm-
  import stz/vm-ir
  import stz/el-ir
  import stz/dl-ir

  ;For STANZA-VERSION
  import stz/params

;============================================================
;=================== Structure ==============================
;============================================================

;Includes both unoptimized and optimized Pkg structures.
public deftype Pkg

;Unoptimized Pkg structure.
public defstruct StdPkg <: Pkg :
  stanza-version:Tuple<Int> with: (default => STANZA-VERSION)
  vmp: VMPackage
  asm: Tuple<Ins>
  datas: Tuple<VMData>

;Optimized Pkg structure.
public defstruct FastPkg <: Pkg :
  stanza-version:Tuple<Int> with: (default => STANZA-VERSION)
  packageio: PackageIO with: (as-method => true)
  exps: Tuple<ETExp>

;============================================================
;=================== Convenience ============================
;============================================================

;Retrieve the PackageIO of a Pkg
public defmulti packageio (pkg:Pkg) -> PackageIO

;Retrieve PackageIO of unoptimized Pkg.
defmethod packageio (pkg:StdPkg) -> PackageIO :
  packageio(vmp(pkg))

;Retrieve name of a package.
public defn name (pkg:Pkg) -> Symbol :
  package(packageio(pkg))

;Retrieve file-extension of a Pkg file.
public defn extension (p:Pkg) -> String :
  match(p) :
    (p:StdPkg) : ".pkg"
    (p:FastPkg) : ".fpkg"

;============================================================
;=================== Printers ===============================
;============================================================

defmethod print (o:OutputStream, p:Pkg) :
  match(p) :
    (p:StdPkg) :
      print(o, "Stanza version: %_" % [stanza-version(p)])
      lnprint(o, vmp(p))
      lnprint(o, "Instructions:")
      val o2 = IndentedStream(o)
      do(lnprint{o2, _}, asm(p))
      lnprint(o, "Datas:")
      do(lnprint{o2, _}, datas(p))
    (p:FastPkg) :
      print(o, "Stanza version: %_" % [stanza-version(p)])
      lnprint(o, packageio(p))
      lnprint(o, "Instructions:")
      val o2 = IndentedStream(o)
      do(lnprint{o2, _}, exps(p))